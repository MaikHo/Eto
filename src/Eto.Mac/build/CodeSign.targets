<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003" ToolsVersion="15.0" >

  <PropertyGroup>
    <!-- search key for the code signing identity for the .app (partial strings match) -->
    <CodeSigningKey Condition="$(CodeSigningKey) == ''"></CodeSigningKey>
    <!-- search key for the code signing identity for the .dmg (partial strings match) -->
    <DmgCodeSigningKey Condition="$(DmgCodeSigningKey) == ''">$(CodeSigningKey)</DmgCodeSigningKey>
  </PropertyGroup>

  <PropertyGroup>
    <MacBuildDmgDependsOnTargets>$(MacBuildDmgDependsOnTargets);MacCodeSignApp_Unsupported;MacCodeSignApp</MacBuildDmgDependsOnTargets>
  </PropertyGroup>

  <Target Name="MacCodeSignApp_Unsupported" AfterTargets="MacBuildAppBundle" DependsOnTargets="$(MacCodeSignDependsOnTargets)" Condition="$(IsMac) != 'True'">
    <Warning Text="Can only code sign an app on macOS" />
  </Target>

  <Target Name="MacCodeSignApp" AfterTargets="MacBuildAppBundle" DependsOnTargets="$(MacCodeSignDependsOnTargets)" Condition="$(IsMac) == 'True'">

    <MSBuild Projects="$(MSBuildThisFileFullPath)" Targets="_MacResolveCodeSignIdentity" Properties="CodeSignSearchKey=$(CodeSigningKey)" >
      <Output TaskParameter="TargetOutputs" PropertyName="ResolvedCodeSigningKey" />
    </MSBuild>

    <PropertyGroup>
      <CodeSignEntitlements Condition="$(CodeSignEntitlements) != '' AND !Exists($(CodeSignEntitlements)) AND Exists('$(MSBuildProjectDirectory)\$(CodeSignEntitlements)')">$(MSBuildProjectDirectory)\$(CodeSignEntitlements)</CodeSignEntitlements>

      <_CodeSignOptions Condition="$(CodeSignEntitlements) != ''">--entitlements "$(CodeSignEntitlements)"</_CodeSignOptions>
    </PropertyGroup>

    <ItemGroup>
      <_CodeSignFiles Include="$(OutputAppPath)" CodeSignOptions="--deep --options runtime $(_CodeSignOptions)" />
    </ItemGroup>

    <Exec Command='codesign --force %(_CodeSignFiles.CodeSignOptions) --sign "$(ResolvedCodeSigningKey)" "@(_CodeSignFiles)"' />
  </Target>

  <Target Name="MacCodeSignDmg" AfterTargets="MacBuildDmg" Condition="$(IsMac) == 'True'">

    <MSBuild Projects="$(MSBuildThisFileFullPath)" Targets="_MacResolveCodeSignIdentity" Properties="CodeSignSearchKey=$(DmgCodeSigningKey)" >
      <Output TaskParameter="TargetOutputs" PropertyName="ResolvedDmgCodeSigningKey" />
    </MSBuild>

    <Exec Command='codesign --force --sign "$(ResolvedDmgCodeSigningKey)" "$(_DmgPath)"' />
  </Target>

  <!-- Resolve a code sign identity.  Parameters: CodeSignSearchKey -->
  <Target Name="_MacResolveCodeSignIdentity" Outputs="$(ResolvedCodeSignIdentity)">

    <!-- get valid identities that match -->
    <Exec Command="security find-identity -v -p codesigning | grep -v 'valid identities found' | grep '$(CodeSignSearchKey)' | awk '{print $2}'"
          ConsoleToMSBuild="True"
          StandardOutputImportance="normal">
        <Output TaskParameter="ConsoleOutput" ItemName="MatchingIdentities"/>
    </Exec>

    <Error Text="Could not find code sign key matching '$(CodeSignSearchKey)'. Ensure you have installed your code sign certificate."
           Condition="@(MatchingIdentities->Count()) == '0'" />

    <Error Text="More than one valid code signing certificate matches '$(CodeSignSearchKey)'. Enter a more specific key for the certificate."
           Condition="@(MatchingIdentities->Count()) > '1'" />

    <PropertyGroup>
      <ResolvedCodeSignIdentity>@(MatchingIdentities)</ResolvedCodeSignIdentity>
    </PropertyGroup>
  </Target>

</Project>